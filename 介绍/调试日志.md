要开启调试日志，需要在构建期间配置nginx支持调试功能。

```
./configure --with-debug ...
```
之后应该使用`error_log`指令设置调试级别：

```
error_log /path/to/log debug;
```

要验证nginx是否已经配置为支持调试功能，请运行`nginx -V`命令：

```
configure arguments: --with-debug ...
```
预构建Linux包为nginx-debug二进制文件的调试日志提供了开箱即用的支持，可以使用命令运行。

```
service nginx stop
service nginx-debug start
```

之后设置`debug`级别。Windows的nginx二进制版本始终调试日志支持构建，因此只需设置为`debug`级别即可。

请注意，重新定义日志而不指定`debug`级别将禁止调试日志。在下面的示例中，重新定义`server`上的日志级别禁止在此服务器上做日志调试。

```
error_log /path/to/log debug;

http {
    server {
        error_log /path/to/log;
        ...
```
为了避免这种情况，重新定义日志级别应该被注释掉，或者明确指定日志为`debug`级别。

```
error_log /path/to/log debug;

http {
    server {
        error_log /path/to/log debug;
        ...
```

## 为指定客户端做调试日志

也可以仅为选定的客户端地址启用调试日志：

```
error_log /path/to/log;

events {
    debug_connection 192.168.1.1;
    debug_connection 192.168.10.0/24;
}
```

## 记录日志到循环内存缓冲区

调试日志可以被写入到循环内存缓冲区中：

```
error_log memory:32m debug;
```

在`debug`级别将日志写入到内存缓冲区中，即使在高负载情况下也不会对性能产生重大的影响。在这种情况下，可以使用如下`gdb`脚本来提取日志：

```gdb
set $log = ngx_cycle->log

while $log->writer != ngx_log_memory_writer
    set $log = $log->next
end

set $buf = (ngx_log_memory_buf_t *) $log->wdata
dump binary memory debug_log.txt $buf->start $buf->end
```

## 原文档

- [http://nginx.org/en/docs/debugging_log.html](http://nginx.org/en/docs/debugging_log.html)